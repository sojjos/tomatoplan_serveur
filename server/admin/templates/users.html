{% extends "base.html" %}

{% block title %}Utilisateurs - TomatoPlan Admin{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="page-header">
        <h1>Gestion des Utilisateurs</h1>
        <button class="btn btn-primary" onclick="showCreateUserModal()">+ Nouvel utilisateur</button>
    </div>

    <div class="filters">
        <label>
            <input type="checkbox" id="show-inactive" onchange="loadUsers()"> Afficher les inactifs
        </label>
    </div>

    <table class="table" id="users-table">
        <thead>
            <tr>
                <th>Username</th>
                <th>Nom</th>
                <th>Rôle</th>
                <th>Statut</th>
                <th>Dernière connexion</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="users-body">
            <tr><td colspan="6">Chargement...</td></tr>
        </tbody>
    </table>
</div>

<!-- Modal Créer/Éditer utilisateur -->
<div id="user-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title">Nouvel utilisateur</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="user-form" onsubmit="saveUser(event)">
            <input type="hidden" id="user-id">
            <div class="form-group">
                <label>Nom d'utilisateur</label>
                <input type="text" id="user-username" required>
            </div>
            <div class="form-group">
                <label>Nom d'affichage</label>
                <input type="text" id="user-display-name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="user-email">
            </div>
            <div class="form-group">
                <label>Rôle</label>
                <select id="user-role">
                    <option value="viewer">Viewer - Consultation</option>
                    <option value="planner">Planner - Planification</option>
                    <option value="planner_advanced">Planner Avancé</option>
                    <option value="driver_admin">Gestionnaire Chauffeurs</option>
                    <option value="finance">Finance</option>
                    <option value="analyse">Analyse</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="user-active" checked> Actif
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Reset Password -->
<div id="password-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Nouveau mot de passe</h2>
            <span class="close" onclick="closePasswordModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Mot de passe temporaire généré :</p>
            <div class="password-display" id="new-password"></div>
            <p class="warning">Communiquez ce mot de passe à l'utilisateur. Il devra le changer à la première connexion.</p>
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" onclick="copyPassword()">Copier</button>
            <button class="btn" onclick="closePasswordModal()">Fermer</button>
        </div>
    </div>
</div>

<style>
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.filters { margin-bottom: 15px; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background: white; padding: 25px; border-radius: 8px; width: 100%; max-width: 500px; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-header h2 { margin: 0; }
.close { font-size: 28px; cursor: pointer; color: #999; }
.close:hover { color: #333; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
.form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
.form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
.password-display { background: #f5f5f5; padding: 15px; font-family: monospace; font-size: 18px; text-align: center; border-radius: 4px; margin: 15px 0; }
.warning { color: #e74c3c; font-size: 14px; }
.badge-active { background: #27ae60; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; }
.badge-inactive { background: #95a5a6; color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; }
.btn-sm { padding: 5px 10px; font-size: 12px; margin: 2px; }
.btn-danger { background: #e74c3c; color: white; }
.btn-warning { background: #f39c12; color: white; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (!isAuthenticated()) {
        window.location.href = '/admin/login';
        return;
    }
    loadUsers();
});

async function loadUsers() {
    const showInactive = document.getElementById('show-inactive').checked;
    const endpoint = showInactive ? '/admin/users' : '/admin/users?active_only=true';

    try {
        const users = await apiCall(endpoint);
        const tbody = document.getElementById('users-body');

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">Aucun utilisateur</td></tr>';
            return;
        }

        tbody.innerHTML = users.map(u => `
            <tr>
                <td><strong>${u.username}</strong></td>
                <td>${u.display_name || '-'}</td>
                <td>${u.role || '-'}</td>
                <td>${u.is_active ? '<span class="badge-active">Actif</span>' : '<span class="badge-inactive">Inactif</span>'}</td>
                <td>${u.last_login ? formatDate(u.last_login) : 'Jamais'}</td>
                <td>
                    <button class="btn btn-sm" onclick="editUser(${u.id})">Éditer</button>
                    <button class="btn btn-sm btn-warning" onclick="resetPassword(${u.id})">Reset MDP</button>
                    ${u.is_active ? `<button class="btn btn-sm btn-danger" onclick="toggleUser(${u.id}, false)">Désactiver</button>` : `<button class="btn btn-sm" onclick="toggleUser(${u.id}, true)">Activer</button>`}
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Erreur:', error);
    }
}

function showCreateUserModal() {
    document.getElementById('modal-title').textContent = 'Nouvel utilisateur';
    document.getElementById('user-form').reset();
    document.getElementById('user-id').value = '';
    document.getElementById('user-active').checked = true;
    document.getElementById('user-modal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('user-modal').style.display = 'none';
}

async function editUser(id) {
    try {
        const users = await apiCall('/admin/users');
        const user = users.find(u => u.id === id);
        if (!user) return;

        document.getElementById('modal-title').textContent = 'Modifier utilisateur';
        document.getElementById('user-id').value = user.id;
        document.getElementById('user-username').value = user.username;
        document.getElementById('user-display-name').value = user.display_name || '';
        document.getElementById('user-email').value = user.email || '';
        document.getElementById('user-role').value = user.role || 'viewer';
        document.getElementById('user-active').checked = user.is_active;
        document.getElementById('user-modal').style.display = 'flex';
    } catch (error) {
        alert('Erreur: ' + error.message);
    }
}

async function saveUser(event) {
    event.preventDefault();
    const id = document.getElementById('user-id').value;
    const data = {
        username: document.getElementById('user-username').value,
        display_name: document.getElementById('user-display-name').value,
        email: document.getElementById('user-email').value,
        role_name: document.getElementById('user-role').value,
        is_active: document.getElementById('user-active').checked
    };

    try {
        if (id) {
            await apiCall(`/admin/users/${id}`, 'PUT', data);
        } else {
            const result = await apiCall('/admin/users', 'POST', data);
            if (result.temp_password) {
                document.getElementById('new-password').textContent = result.temp_password;
                document.getElementById('password-modal').style.display = 'flex';
            }
        }
        closeModal();
        loadUsers();
    } catch (error) {
        alert('Erreur: ' + error.message);
    }
}

async function resetPassword(id) {
    if (!confirm('Réinitialiser le mot de passe ?')) return;

    try {
        const result = await apiCall(`/admin/users/${id}/reset-password`, 'POST');
        document.getElementById('new-password').textContent = result.temp_password;
        document.getElementById('password-modal').style.display = 'flex';
    } catch (error) {
        alert('Erreur: ' + error.message);
    }
}

async function toggleUser(id, active) {
    const action = active ? 'activer' : 'désactiver';
    if (!confirm(`Voulez-vous ${action} cet utilisateur ?`)) return;

    try {
        await apiCall(`/admin/users/${id}`, 'PUT', { is_active: active });
        loadUsers();
    } catch (error) {
        alert('Erreur: ' + error.message);
    }
}

function closePasswordModal() {
    document.getElementById('password-modal').style.display = 'none';
}

function copyPassword() {
    const pwd = document.getElementById('new-password').textContent;
    navigator.clipboard.writeText(pwd);
    alert('Mot de passe copié !');
}
</script>
{% endblock %}
