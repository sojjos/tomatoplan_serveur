{% extends "base.html" %}

{% block title %}Backups - TomatoPlan Admin{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="page-header">
        <h1>Gestion des Backups</h1>
        <button class="btn btn-primary" onclick="createBackup()">+ Nouveau Backup</button>
    </div>

    <div class="backup-info">
        <div class="info-card">
            <h3>Base de données</h3>
            <p>Taille: <strong id="db-size">-</strong></p>
            <p>Chemin: <code id="db-path">-</code></p>
        </div>
        <div class="info-card">
            <h3>Configuration backup</h3>
            <p>Backup auto: <strong id="auto-backup">-</strong></p>
            <p>Rétention: <strong id="retention">-</strong> jours</p>
        </div>
    </div>

    <h2>Backups disponibles</h2>
    <table class="table" id="backups-table">
        <thead>
            <tr>
                <th>Fichier</th>
                <th>Taille</th>
                <th>Date de création</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="backups-body">
            <tr><td colspan="5">Chargement...</td></tr>
        </tbody>
    </table>
</div>

<!-- Modal Créer Backup -->
<div id="backup-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Nouveau Backup</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="backup-form" onsubmit="submitBackup(event)">
            <div class="form-group">
                <label>Description (optionnel)</label>
                <input type="text" id="backup-description" placeholder="Ex: Avant mise à jour">
            </div>
            <div class="form-actions">
                <button type="button" class="btn" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn btn-primary" id="btn-create">Créer le backup</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Restauration -->
<div id="restore-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirmer la restauration</h2>
            <span class="close" onclick="closeRestoreModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p class="warning">ATTENTION: Cette action va remplacer toutes les données actuelles par celles du backup sélectionné.</p>
            <p>Backup: <strong id="restore-filename">-</strong></p>
            <p>Un backup automatique sera créé avant la restauration.</p>
        </div>
        <div class="form-actions">
            <button class="btn" onclick="closeRestoreModal()">Annuler</button>
            <button class="btn btn-danger" onclick="confirmRestore()">Restaurer</button>
        </div>
    </div>
</div>

<style>
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.backup-info { display: flex; gap: 20px; margin-bottom: 30px; }
.info-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1; }
.info-card h3 { margin: 0 0 15px 0; color: #2c3e50; }
.info-card p { margin: 5px 0; }
.info-card code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
h2 { margin-bottom: 15px; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background: white; padding: 25px; border-radius: 8px; width: 100%; max-width: 500px; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.modal-header h2 { margin: 0; }
.close { font-size: 28px; cursor: pointer; color: #999; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
.form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
.form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
.warning { color: #e74c3c; background: #fee; padding: 15px; border-radius: 4px; margin-bottom: 15px; }
.btn-danger { background: #e74c3c; color: white; }
.btn-sm { padding: 5px 10px; font-size: 12px; margin: 2px; }
</style>

<script>
let selectedBackup = null;

document.addEventListener('DOMContentLoaded', function() {
    if (!isAuthenticated()) {
        window.location.href = '/admin/login';
        return;
    }
    loadBackupInfo();
    loadBackups();
});

async function loadBackupInfo() {
    try {
        const stats = await apiCall('/stats/dashboard');
        document.getElementById('db-size').textContent = stats.database?.size_formatted || '-';
        document.getElementById('db-path').textContent = stats.database?.path || '-';

        const config = await apiCall('/admin/config');
        document.getElementById('auto-backup').textContent = config.auto_backup_enabled ? 'Activé' : 'Désactivé';
        document.getElementById('retention').textContent = config.backup_retention_days || '30';
    } catch (error) {
        console.error('Erreur:', error);
    }
}

async function loadBackups() {
    try {
        const backups = await apiCall('/admin/backups');
        const tbody = document.getElementById('backups-body');

        if (backups.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Aucun backup disponible</td></tr>';
            return;
        }

        tbody.innerHTML = backups.map(b => `
            <tr>
                <td><strong>${b.filename}</strong></td>
                <td>${formatSize(b.size_bytes)}</td>
                <td>${formatDate(b.created_at)}</td>
                <td>${b.description || '-'}</td>
                <td>
                    <button class="btn btn-sm" onclick="downloadBackup('${b.filename}')">Télécharger</button>
                    <button class="btn btn-sm btn-warning" onclick="showRestoreModal('${b.filename}')">Restaurer</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBackup('${b.filename}')">Supprimer</button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Erreur:', error);
    }
}

function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function createBackup() {
    document.getElementById('backup-description').value = '';
    document.getElementById('backup-modal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('backup-modal').style.display = 'none';
}

async function submitBackup(event) {
    event.preventDefault();
    const description = document.getElementById('backup-description').value;
    const btn = document.getElementById('btn-create');

    btn.disabled = true;
    btn.textContent = 'Création en cours...';

    try {
        await apiCall('/admin/backups', 'POST', { description });
        closeModal();
        showToast('Backup créé avec succès', 'success');
        loadBackups();
    } catch (error) {
        alert('Erreur: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'Créer le backup';
    }
}

async function downloadBackup(filename) {
    try {
        const response = await fetch(`/admin/backups/${filename}/download`, {
            headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
    } catch (error) {
        alert('Erreur téléchargement: ' + error.message);
    }
}

function showRestoreModal(filename) {
    selectedBackup = filename;
    document.getElementById('restore-filename').textContent = filename;
    document.getElementById('restore-modal').style.display = 'flex';
}

function closeRestoreModal() {
    document.getElementById('restore-modal').style.display = 'none';
    selectedBackup = null;
}

async function confirmRestore() {
    if (!selectedBackup) return;

    try {
        await apiCall(`/admin/backups/${selectedBackup}/restore`, 'POST');
        closeRestoreModal();
        showToast('Restauration effectuée. Redémarrage du serveur...', 'success');
        setTimeout(() => {
            window.location.reload();
        }, 3000);
    } catch (error) {
        alert('Erreur: ' + error.message);
    }
}

async function deleteBackup(filename) {
    if (!confirm(`Supprimer le backup ${filename} ?`)) return;

    try {
        await apiCall(`/admin/backups/${filename}`, 'DELETE');
        showToast('Backup supprimé', 'success');
        loadBackups();
    } catch (error) {
        alert('Erreur: ' + error.message);
    }
}
</script>
{% endblock %}
