{% extends "base.html" %}

{% block title %}Sessions - TomatoPlan Admin{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="page-header">
        <h1>Sessions Actives</h1>
        <div class="header-actions">
            <button class="btn btn-danger" onclick="kickAllSessions()">Déconnecter tout le monde</button>
            <button class="btn" onclick="loadSessions()">Rafraîchir</button>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-value" id="total-sessions">-</div>
            <div class="stat-label">Sessions actives</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="unique-users">-</div>
            <div class="stat-label">Utilisateurs connectés</div>
        </div>
    </div>

    <table class="table" id="sessions-table">
        <thead>
            <tr>
                <th>Utilisateur</th>
                <th>Rôle</th>
                <th>IP Client</th>
                <th>Hostname</th>
                <th>Connecté depuis</th>
                <th>Dernière activité</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="sessions-body">
            <tr><td colspan="7">Chargement...</td></tr>
        </tbody>
    </table>

    <div class="section">
        <h2>Historique des connexions récentes</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Utilisateur</th>
                    <th>Action</th>
                    <th>IP</th>
                    <th>Détails</th>
                </tr>
            </thead>
            <tbody id="login-history">
                <tr><td colspan="5">Chargement...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<style>
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.header-actions { display: flex; gap: 10px; }
.stats-row { display: flex; gap: 20px; margin-bottom: 20px; }
.stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 150px; text-align: center; }
.stat-value { font-size: 32px; font-weight: bold; color: #3498db; }
.stat-label { color: #7f8c8d; font-size: 14px; }
.section { margin-top: 30px; }
.section h2 { margin-bottom: 15px; }
.btn-danger { background: #e74c3c; color: white; border: none; }
.btn-danger:hover { background: #c0392b; }
.btn-warning { background: #f39c12; color: white; border: none; }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.badge-online { background: #27ae60; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px; }
.badge-login { background: #27ae60; }
.badge-logout { background: #3498db; }
.badge-failed { background: #e74c3c; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (!isAuthenticated()) {
        window.location.href = '/admin/login';
        return;
    }
    loadSessions();
    loadLoginHistory();
    // Rafraîchir toutes les 10 secondes
    setInterval(loadSessions, 10000);
});

async function loadSessions() {
    try {
        const sessions = await apiCall('/admin/sessions');
        const tbody = document.getElementById('sessions-body');

        document.getElementById('total-sessions').textContent = sessions.length;
        const uniqueUsers = new Set(sessions.map(s => s.username)).size;
        document.getElementById('unique-users').textContent = uniqueUsers;

        if (sessions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7">Aucune session active</td></tr>';
            return;
        }

        tbody.innerHTML = sessions.map(s => `
            <tr>
                <td>
                    <strong>${s.username}</strong>
                    <span class="badge-online">En ligne</span>
                </td>
                <td>${s.role || '-'}</td>
                <td>${s.client_ip || '-'}</td>
                <td>${s.hostname || '-'}</td>
                <td>${formatDate(s.connected_at)}</td>
                <td>${formatDate(s.last_activity)}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="kickSession('${s.session_id}', '${s.username}')">
                        Déconnecter
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Erreur:', error);
    }
}

async function loadLoginHistory() {
    try {
        const logs = await apiCall('/stats/activity/recent?limit=20&action_type=LOGIN,LOGOUT,LOGIN_FAILED');
        const tbody = document.getElementById('login-history');

        if (!logs || logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">Aucun historique</td></tr>';
            return;
        }

        tbody.innerHTML = logs.map(l => {
            let badgeClass = 'badge-login';
            if (l.action_type === 'LOGOUT') badgeClass = 'badge-logout';
            if (l.action_type === 'LOGIN_FAILED') badgeClass = 'badge-failed';

            return `
                <tr>
                    <td>${formatDate(l.created_at)}</td>
                    <td><strong>${l.username}</strong></td>
                    <td><span class="badge ${badgeClass}">${l.action_type}</span></td>
                    <td>${l.client_ip || '-'}</td>
                    <td>${l.details || '-'}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Erreur historique:', error);
    }
}

async function kickSession(sessionId, username) {
    if (!confirm(`Déconnecter ${username} ?`)) return;

    try {
        await apiCall(`/admin/sessions/${sessionId}/kick`, 'POST');
        showToast(`${username} a été déconnecté`, 'success');
        loadSessions();
    } catch (error) {
        alert('Erreur: ' + error.message);
    }
}

async function kickAllSessions() {
    if (!confirm('Déconnecter TOUS les utilisateurs ? (Vous serez aussi déconnecté)')) return;

    try {
        await apiCall('/admin/sessions/kick-all', 'POST');
        showToast('Tous les utilisateurs ont été déconnectés', 'success');
        setTimeout(() => {
            logout();
        }, 1500);
    } catch (error) {
        alert('Erreur: ' + error.message);
    }
}
</script>
{% endblock %}
